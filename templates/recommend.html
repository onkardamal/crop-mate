<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CropMate - Smart Recommendation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { background: #fff; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.1); padding: 2rem; margin-top: 2rem; margin-bottom: 2rem; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 2rem; }
        .section-title { color: #764ba2; margin-top: 2rem; margin-bottom: 1rem; }
        .auto-detect-btn { margin-bottom: 1rem; }
        .result-card { border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-top: 2rem; }
        .suitability-score { font-size: 1.5rem; font-weight: bold; color: #28a745; }
        .score-excellent { color: #28a745; }
        .score-good { color: #ffc107; }
        .score-fair { color: #fd7e14; }
        .score-poor { color: #dc3545; }
        .breakdown-list { font-size: 1rem; }
        .profitability { font-size: 1.1rem; color: #007bff; }
        .crop-image { width: 100px; height: 100px; object-fit: cover; border-radius: 10px; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">
            <i class="bi bi-flower1"></i> CropMate
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link active" href="/recommend">Recommendation</a></li>
                <li class="nav-item"><a class="nav-link" href="/compare">Compare Crops</a></li>
                <li class="nav-item"><a class="nav-link" href="/profitability">Profitability Calculator</a></li>
                <li class="nav-item"><a class="nav-link" href="/calendar">Seasonal Calendar</a></li>
                <li class="nav-item"><a class="nav-link" href="/practices">Best Practices</a></li>
                <li class="nav-item"><a class="nav-link" href="/suitability">Local Suitability</a></li>
                <li class="nav-item"><a class="nav-link" href="/schemes">Schemes & Support</a></li>
                <li class="nav-item"><a class="nav-link" href="/market">Market Trends</a></li>
                <li class="nav-item"><a class="nav-link" href="/community">Community</a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="container">
    <h1><i class="bi bi-lightbulb"></i> Smart Crop Recommendation</h1>
    <form id="recommendForm">
        <!-- Soil & Weather Input -->
        <h4 class="section-title"><i class="bi bi-droplet-half"></i> Soil & Weather</h4>
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label for="Nitrogen" class="form-label">Nitrogen (N)</label>
                <input type="number" class="form-control" id="Nitrogen" name="Nitrogen" min="0" max="140" step="0.1">
            </div>
            <div class="col-md-2">
                <label for="Phosporus" class="form-label">Phosphorus (P)</label>
                <input type="number" class="form-control" id="Phosporus" name="Phosporus" min="0" max="140" step="0.1">
            </div>
            <div class="col-md-2">
                <label for="Potassium" class="form-label">Potassium (K)</label>
                <input type="number" class="form-control" id="Potassium" name="Potassium" min="0" max="200" step="0.1">
            </div>
            <div class="col-md-2">
                <label for="pH" class="form-label">pH</label>
                <input type="number" class="form-control" id="pH" name="pH" min="3" max="10" step="0.01">
            </div>
            <div class="col-md-2">
                <label for="Temperature" class="form-label">Temperature (°C)</label>
                <input type="number" class="form-control" id="Temperature" name="Temperature" min="0" max="50" step="0.1">
            </div>
            <div class="col-md-2">
                <label for="Humidity" class="form-label">Humidity (%)</label>
                <input type="number" class="form-control" id="Humidity" name="Humidity" min="0" max="100" step="0.1">
            </div>
            <div class="col-md-2">
                <label for="Rainfall" class="form-label">Rainfall (mm)</label>
                <input type="number" class="form-control" id="Rainfall" name="Rainfall" min="0" max="4000" step="0.1">
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-primary auto-detect-btn" id="autoDetectBtn">
                    <i class="bi bi-geo-alt"></i> Auto Detect Location & Weather
                </button>
            </div>
        </div>
        <!-- Location & Season -->
        <h4 class="section-title"><i class="bi bi-geo"></i> Location & Season</h4>
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="stateSelect" class="form-label">State</label>
                <select id="stateSelect" name="state" class="form-select">
                    <option value="">Auto/Select State</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="districtSelect" class="form-label">District</label>
                <select id="districtSelect" name="district" class="form-select">
                    <option value="">Auto/Select District</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="seasonSelect" class="form-label">Season</label>
                <select id="seasonSelect" name="season" class="form-select">
                    <option value="">Auto/All Seasons</option>
                    <option value="kharif">Kharif (June-Oct)</option>
                    <option value="rabi">Rabi (Nov-Mar)</option>
                    <option value="zaid">Zaid (Mar-Jun)</option>
                </select>
            </div>
        </div>
        <!-- Area & Cost (Optional) -->
        <h4 class="section-title"><i class="bi bi-cash-coin"></i> Area & Cost (Optional)</h4>
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="area" class="form-label">Area (hectares)</label>
                <input type="number" class="form-control" id="area" name="area" min="0" step="0.01">
            </div>
            <div class="col-md-4">
                <label for="costs" class="form-label">Estimated Costs (₹)</label>
                <input type="number" class="form-control" id="costs" name="costs" min="0" step="0.01">
            </div>
        </div>
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success btn-lg"><i class="bi bi-lightning-charge"></i> Get Recommendation</button>
        </div>
    </form>
    <!-- Results Section -->
    <div id="recommendationResults"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- State & District Data ---
let stateDistricts = {};

// --- Load States on Page Load ---
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/states')
        .then(res => res.json())
        .then(states => {
            const stateSelect = document.getElementById('stateSelect');
            states.forEach(state => {
                const opt = document.createElement('option');
                opt.value = state;
                opt.textContent = state;
                stateSelect.appendChild(opt);
            });
        });
    // Load districts when state changes
    document.getElementById('stateSelect').addEventListener('change', function() {
        const state = this.value;
        loadDistricts(state);
    });
    // Auto-detect button
    document.getElementById('autoDetectBtn').addEventListener('click', autoDetectAll);
    // Form submit
    document.getElementById('recommendForm').addEventListener('submit', handleRecommendationSubmit);
});

function loadDistricts(state) {
    const districtSelect = document.getElementById('districtSelect');
    districtSelect.innerHTML = '<option value="">Auto/Select District</option>';
    if (!state) return;
    fetch(`/api/suitability/${encodeURIComponent(state)}`)
        .then(res => res.json())
        .then(data => {
            if (data.state_info && data.state_info.districts) {
                data.state_info.districts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    districtSelect.appendChild(opt);
                });
                // Auto-select if only one district
                if (data.state_info.districts.length === 1) {
                    districtSelect.value = data.state_info.districts[0];
                }
            }
        });
}

// --- Auto Detect Location & Weather ---
function autoDetectAll() {
    const btn = document.getElementById('autoDetectBtn');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Detecting...';
    btn.disabled = true;
    fetch('/api/auto-detect')
        .then(res => res.json())
        .then(data => {
            // Fill state
            if (data.nearest_state) {
                document.getElementById('stateSelect').value = data.nearest_state;
                loadDistricts(data.nearest_state);
            }
            // Fill weather
            if (data.weather) {
                if (data.weather.temperature) document.getElementById('Temperature').value = data.weather.temperature;
                if (data.weather.humidity) document.getElementById('Humidity').value = data.weather.humidity;
                if (data.weather.rainfall) document.getElementById('Rainfall').value = data.weather.rainfall;
            } else if (data.climate_zone) {
                document.getElementById('Temperature').value = data.climate_zone.current_temp;
                document.getElementById('Humidity').value = data.climate_zone.current_humidity;
            }
        })
        .catch(() => showAlert('Auto-detect failed. Please fill manually.', 'danger'))
        .finally(() => {
            btn.innerHTML = '<i class="bi bi-geo-alt"></i> Auto Detect Location & Weather';
            btn.disabled = false;
        });
}

// --- Form Submission ---
function handleRecommendationSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const payload = {};
    formData.forEach((v, k) => { if (v) payload[k] = v; });
    showLoading();
    // AJAX POST
    fetch('/api/smart-recommend', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => displayRecommendationResults(data, payload))
    .catch(() => showAlert('Failed to get recommendation.', 'danger'))
    .finally(hideLoading);
}

// --- Loading Spinner ---
function showLoading() {
    const resultsDiv = document.getElementById('recommendationResults');
    resultsDiv.innerHTML = `<div class='text-center my-4'><div class='spinner-border text-primary' role='status'></div><p>Analyzing your inputs...</p></div>`;
}
function hideLoading() {
    // No-op: handled by displayRecommendationResults
}

// --- Display Results (Top 3 Crops) ---
function displayRecommendationResults(data, payload) {
    const resultsDiv = document.getElementById('recommendationResults');
    if (data.error) {
        resultsDiv.innerHTML = `<div class='alert alert-danger'><i class='bi bi-exclamation-triangle'></i> ${data.error}</div>`;
        return;
    }
    if (!data.top_crops || data.top_crops.length === 0) {
        resultsDiv.innerHTML = `<div class='alert alert-warning'>No suitable crop found for the given inputs.</div>`;
        return;
    }
    // Show top 3 crops
    resultsDiv.innerHTML = `<h3 class='mb-3'><i class='bi bi-award'></i> Top Recommendations</h3>` +
        data.top_crops.map((crop, idx) => cropCardHTML(crop, idx)).join('');
    // Add expand/collapse for details
    data.top_crops.forEach((crop, idx) => {
        document.getElementById(`expandBtn${idx}`).onclick = function() {
            const details = document.getElementById(`details${idx}`);
            details.style.display = details.style.display === 'none' ? 'block' : 'none';
            this.innerHTML = details.style.display === 'none' ? 'Show Details' : 'Hide Details';
        };
    });
    // Retain user input
    for (const [k, v] of Object.entries(payload)) {
        if (document.getElementById(k)) document.getElementById(k).value = v;
    }
}
function cropCardHTML(crop, idx) {
    return `
    <div class='card result-card mb-4'>
        <div class='card-body'>
            <div class='row align-items-center'>
                <div class='col-md-3 text-center'>
                    <img src='/static/images/${crop.image || 'crop.png'}' class='crop-image mb-2' alt='${crop.crop}'>
                    <h4>${crop.crop}</h4>
                    <div class='suitability-score ${getScoreClass(crop.total_score)}'>${crop.total_score}%</div>
                </div>
                <div class='col-md-9'>
                    <button class='btn btn-outline-primary btn-sm mb-2' id='expandBtn${idx}'>Show Details</button>
                    <div id='details${idx}' style='display:none;'>
                        <h6>Why this crop?</h6>
                        <ul class='breakdown-list'>
                            <li><b>Soil/Nutrient Fit:</b> ${crop.breakdown.soil_score}%</li>
                            <li><b>Weather Fit:</b> ${crop.breakdown.weather_score}%</li>
                            <li><b>Local Suitability:</b> ${crop.breakdown.local_score}%</li>
                            <li><b>Seasonal Fit:</b> ${crop.breakdown.season_score}%</li>
                            <li><b>Profitability:</b> ${crop.breakdown.profit_score}%</li>
                        </ul>
                        <div class='profitability'><b>Estimated Profit:</b> ₹${crop.estimated_profit || 'N/A'}</div>
                        <div class='mt-2'><b>Description:</b> ${crop.description || ''}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>`;
}
function getScoreClass(score) {
    if (score >= 80) return 'score-excellent';
    if (score >= 60) return 'score-good';
    if (score >= 40) return 'score-fair';
    return 'score-poor';
}
function showAlert(msg, type) {
    const div = document.createElement('div');
    div.className = `alert alert-${type}`;
    div.innerHTML = msg;
    document.getElementById('recommendationResults').prepend(div);
    setTimeout(() => div.remove(), 4000);
}
</script>
</body>
</html> 